var BLANK = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",
    discount = "",
    current_ip_add = $(".current_ip_add").val();
$.fn.imagesLoaded = function(a) {
    function b() {
        var b = $(i),
            c = $(j);
        e && (j.length ? e.reject(g, b, c) : e.resolve(g)), $.isFunction(a) && a.call(d, g, b, c)
    }

    function c(a, c) {
        a.src !== BLANK && -1 === $.inArray(a, h) && (h.push(a), c ? j.push(a) : i.push(a), $.data(a, "imagesLoaded", {
            isBroken: c,
            src: a.src
        }), f && e.notifyWith($(a), [c, g, $(i), $(j)]), g.length === h.length && (setTimeout(b), g.unbind(".imagesLoaded")))
    }
    var d = this,
        e = $.isFunction($.Deferred) ? $.Deferred() : 0,
        f = $.isFunction(e.notify),
        g = d.find("img").add(d.filter("img")),
        h = [],
        i = [],
        j = [];
    return $.isPlainObject(a) && $.each(a, function(b, c) {
        "callback" === b ? a = c : e && e[b](c)
    }), g.length ? g.bind("load.imagesLoaded error.imagesLoaded", function(a) {
        c(a.target, "error" === a.type)
    }).each(function(a, b) {
        var d = b.src,
            e = $.data(b, "imagesLoaded");
        return e && e.src === d ? void c(b, e.isBroken) : b.complete && void 0 !== b.naturalWidth ? void c(b, 0 === b.naturalWidth || 0 === b.naturalHeight) : void((b.readyState || b.complete) && (b.src = BLANK, b.src = d))
    }) : b(), e ? e.promise(d) : d
};
var Grid = function() {
    function a(a) {
        x = $.extend(!0, {}, x, a), m.imagesLoaded(function() {
            c(!0), f(), d()
        })
    }

    function b(a) {
        n = n.add(a), a.each(function() {
            var a = $(this);
            a.data({
                offsetTop: a.offset().top,
                height: a.height() + 10
            })
        }), e(a)
    }

    function c(a) {
        n.each(function() {
            var b = $(this);
            b.data("offsetTop", b.offset().top), a && b.data("height", b.height())
        })
    }

    function d() {
        e(n), s.on("debouncedresize", function() {
            q = 0, p = -1, c(), f();
            var a = $.data(this, "preview");
            "undefined" != typeof a && h()
        })
    }

    function e(a) {
        c(), a.on("click", "span.og-close", function() {
            return h(), !1
        }).children("div").on("click", function(a) {
            $(".sidebar-offcanvas").removeClass("active");
            var b = $(this).parent();
            return o === b.index() ? h() : g(b), !1
        })
    }

    function f() {
        k = {
            width: s.width(),
            height: s.height()
        }
    }

    function g(a) {
        var b = $.data(this, "preview"),
            c = a.data("offsetTop");
        if (q = 0, "undefined" != typeof b) {
            if (p === c) return b.update(a), !1;
            c > p && (q = b.height), h()
        }
        p = c, b = $.data(this, "preview", new i(a)), b.open()
    }

    function h() {
        o = -1;
        var a = $.data(this, "preview");
        a.close(), $.removeData(this, "preview")
    }

    function i(a) {
        this.$item = a, this.expandedIdx = this.$item.index(), this.create(), this.update()
    }
    if ($(window).width() >= 767) var j = "#posts .hidden-xs";
    else var j = "#posts";
    var k, l = j,
        m = $(l),
        n = m.children("li"),
        o = -1,
        p = -1,
        q = 0,
        r = 10,
        s = $(window),
        t = $("html, body"),
        u = {
            WebkitTransition: "webkitTransitionEnd",
            MozTransition: "transitionend",
            OTransition: "oTransitionEnd",
            msTransition: "MSTransitionEnd",
            transition: "transitionend"
        },
        v = u[Modernizr.prefixed("transition")],
        w = Modernizr.csstransitions,
        x = {
            minHeight: 500,
            speed: 350,
            easing: "ease",
            showVisitButton: !0
        };
    return i.prototype = {
        create: function() {
            this.$title = $('<div class="title_div"></div>');
            this.$low_price_text = $('<li class="low_price_text"></li>');
            this.$original_price = $('<li class="original_price"></li>');
            this.$price = $('<li class="price"></li>');
            this.$store = $("<li></li>");
            this.$discount_ul = $("<li class=discount></li>");
            this.$price_ul = $('<ul class="list-unstyled"></ul>').append(this.$discount_ul, this.$low_price_text, this.$original_price, this.$price, this.$store);
            this.$pricing_div = $('<div class="price_div"></div>').append(this.$price_ul);
            this.$delivery_ul = $('<ul class="delivery_ul list-unstyled"></ul>');
            this.$delivery_div = $('<div class="delivery_div hidden-md hidden-sm" style=""></div>').append(this.$delivery_ul);
            this.$second_div = $('<div class="second_div"></div>').append(this.$pricing_div, this.$delivery_div);
            this.$extra_details_ul = $('<ul class="extra_details_ul"></ul>');
            this.$buy_link = $('<a rel="nofollow" return false;" href="javascript: void(0)" class="btn" target="_blank">Buy</a>');
            this.$buy_link_div = $('<div class="buy_link"></div>').append(this.$buy_link);
            this.$extra_details_div = $('<div class="extra_details_div"></div>').append(this.$extra_details_ul);
            this.$details = $('<div class="og-details"></div>').append(this.$title, this.$second_div, this.$extra_details_div, this.$buy_link_div, this.$href);
            this.$loading = $('<div class="og-loading"></div>');
            this.$same_images = $('<div class="prod_img_ul"><ul class="list-unstyled"></ul></div>');
            this.$fullimage = $('<div class="og-fullimg"></div>').append(this.$loading);
            this.$lft_detail = $('<div class="lft-img-set"></div>').append(this.$fullimage);
            this.$closePreview = $('<span class="og-close"></span>');
            this.$previewInner = $('<div class="og-expander-inner"></div>').append( this.$closePreview, this.$same_images, this.$lft_detail, this.$details);
            this.updatingWindow = $('<div class="loading" style="position: absolute;height: 125px;left: 478px;top: 15%;float: right;width: 34%;background: #ddd;z-index: 99;display: block;"><div class="loading_caption" style="position: absolute;left: 0;top: 20%;width: 100%;"><img src="http://karanverma.me/images/ring.gif" style="position: relative;left: 11%;height: 50px;margin-bottom:0.5em;"><p style="margin-left: 5%;">Updating price</p></div></div>');            
            this.$previewEl = $('<div class="og-expander"></div>').append( this.updatingWindow, this.$previewInner);
            this.$item.append(this.getEl()), w && this.setTransition();
        },
        update: function(a) {
            window.preview = this, a ? window.preview.$item = a : window.preview.$item = this.$item, search_name = $(".search-name").val(), recipient = this.$item.attr("data-viewid"), mixpanel.track("product_click", {
                prod_id: recipient,
                source: "prod-detail",
                query: search_name
            }), $.ajax({
                url: "/product/" + this.$item.attr("data-viewid"),
                type: "GET",
                dataType: "json",
                success: function(a) { 
                    console.log("Successful!!");
                    var b = "",
                        c = "",
                        d = "",
                        e = "",
                        f = "",
                        g = a.kv_pairs,
                        h = '<i class="fa fa-inr"></i> ' + a.price,
                        i = a.aff,
                        j = a.pid,
                        k = 0,
                        l = 0;
                    if (store_name = a.store.split(".")[0], history.pushState(null, "", "/search/?q=" + search_name + "&pid=" + this.url.split("/")[this.url.split("/").length - 1]), "snapdeal" == a.store.split(".")[0]) var m = a.url + "?utm_source=aff_prog&utm_campaign=afts&offer_id=17&aff_id=79763";
                    else if ("omgp" == i) var m = "http://clk.omgt5.com/?AID=599965&PID=" + j + "&Type=12&r=" + encodeURIComponent(a.url);
                    else var m = a.url;
                    switch (store_name) {
                        case "shopnineteen":
                            var m = "http://tracking.payoom.com/aff_c?offer_id=630&aff_id=10274&url=" + encodeURIComponent(a.url) + "?utm_source=Payoom&utm_medium=Affiliate&nineaflt=GVT";
                            break;
                        case "shoppersstop":
                            var m = "http://tracking.payoom.com/aff_c?offer_id=846&aff_id=10274&url=" + encodeURIComponent(a.url) + "?utm_source=affiliate&utm_medium=ban&utm_campaign=ss_payoom&utm_content=homepage";
                            break;
                        case "syberplace":
                            var m = "http://tracking.payoom.com/aff_c?offer_id=727&aff_id=10274&url=" + encodeURIComponent(a.url) + "?utm_source=payoom&utm_medium=CPS&utm_campaign=affiliate";
                            break;
                        case "indianroots":
                            var m = "http://tracking.payoom.com/aff_c?offer_id=743&aff_id=10274&url=" + encodeURIComponent(a.url) + "?utm_source=payoom&utm_medium=affiliate&utm_campaign=indianroots_test";
                            break;
                        case "americanswan":
                            var m = "http://tracking.payoom.com/aff_c?offer_id=28&aff_id=10274&url=" + encodeURIComponent(a.url) + "?utm_source=payoom-cps";
                            break;
                        case "askmebazaar":
                            console.log("askmebazaar switch condition called");
                            var m = "http://tracking.payoom.com/aff_c?offer_id=570&aff_id=10274&url=" + encodeURIComponent(a.url) + "?utm_source=affiliate&utm_medium=payoom";
                            break;
                        case "chumbak":
                            var m = "http://tracking.payoom.com/aff_c?offer_id=265&aff_id=10274&url=" + encodeURIComponent(a.url) + "?utm_campaign=Payoom-Affiliate&utm_medium=Affiliate&utm_source=cps";
                            break;
                        case "dailyobjects":
                            var m = "http://tracking.payoom.com/aff_c?offer_id=335&aff_id=10274&url=" + encodeURIComponent(a.url) + "?utm_source=Payoom&utm_medium=Banner&utm_campaign=Payoom%20Affiliate";
                            break;
                        case "floweraura":
                            var m = "http://tracking.payoom.com/aff_c?offer_id=610&aff_id=10274&url=" + encodeURIComponent(a.url) + "?utm_source=mooya&utm_medium=affiliate&utm_campaign=cps";
                            break;
                        case "indiacircus":
                            var m = "http://tracking.payoom.com/aff_c?offer_id=506&aff_id=10274&url=" + encodeURIComponent(a.url) + "?utm_source=Payoom&utm_medium=Banners&utm_campaign=Special25";
                            break;
                        case "koovs":
                            var m = "http://tracking.payoom.com/aff_c?offer_id=98&aff_id=10274&url=" + encodeURIComponent(a.url) + "?shp=1&utm_source=payoom&utm_medium=cpa&utm_campaign=20140320";
                            break;
                        case "lenskart":
                            var m = "http://tracking.payoom.com/aff_c?offer_id=32&aff_id=10274&url=" + encodeURIComponent(a.url) + "?utm_source=payoom";
                            break;
                        case "limeroad":
                            var m = "http://tracking.payoom.com/aff_c?offer_id=74&aff_id=10274&url=" + encodeURIComponent(a.url) + "?utm_source=affiliates&utm_medium=payoom_paid&utm_campaign=default";
                            break;
                        case "styletag":
                            var m = "http://tracking.payoom.com/aff_c?offer_id=758&aff_id=10274&url=" + encodeURIComponent(a.url) + "?utm_campaign=payoom&utm_medium=affiliate&utm_source=referral&src=payoom";
                            break;
                        case "purplle":
                            var m = "http://tracking.payoom.com/aff_c?offer_id=522&aff_id=10274&url=" + encodeURIComponent(a.url) + "?utm_source=payoom&utm_medium=affiliate&utm_campaign=522"
                    }
                    if ("lenskart" == a.store.split(".")[0]) var p = "45x25";
                    else if ("fabfurnish" == a.store.split(".")[0]) var p = "70x30";
                    else if ("indiatimes" == a.store.split(".")[0]) var p = "50x35";
                    else if ("koovs" == a.store.split(".")[0]) var p = "40x13";
                    else if ("sports365" == a.store.split(".")[0]) var p = "40x20";
                    else if ("basicslife" == a.store.split(".")[0]) var p = "50x16";
                    else if ("zovi" == a.store.split(".")[0]) var p = "60x20";
                    else if ("flipkart" == a.store.split(".")[0]) var p = "55x37";
                    else if ("indianroots" == a.store.split(".")[0]) var p = "60x25";
                    else if ("shoppersstop" == a.store.split(".")[0]) var p = "70x30";
                    else if ("homeshop18" == a.store.split(".")[0]) var p = "50x31";
                    else if ("askmebazaar" == a.store.split(".")[0]) var p = "30x30";
                    else var p = "89x20";
                    if ("fashionara" == a.store.split(".")[0] || "bewakoof" == a.store.split(".")[0]) var q = "<img src=http://" + current_ip_add + "/static/img/store-img/" + a.store.split(".")[0] + ".png class='fashionara_img_dsktp'>";
                    else if ("fabfurnish" == a.store.split(".")[0]) var q = "<img src=http://d2ifi3luoci66e.cloudfront.net/unsafe/adaptive-full-fit-in/" + p + "/http://" + current_ip_add + "/static/img/store-img/" + a.store.split(".")[0] + "-new.png>";
                    else if ("koovs" == a.store.split(".")[0]) var q = "<img src=http://d2ifi3luoci66e.cloudfront.net/unsafe/adaptive-full-fit-in/" + p + "/http://" + current_ip_add + "/static/img/store-img/" + a.store.split(".")[0] + "_new.png>";
                    else if ("sports365" == a.store.split(".")[0]) var q = "<img src=http://d2ifi3luoci66e.cloudfront.net/unsafe/adaptive-full-fit-in/" + p + "/http://" + current_ip_add + "/static/img/store-img/" + a.store.split(".")[0] + ".png>";
                    else if ("flipkart" == a.store.split(".")[0]) var q = "<img src=http://d2ifi3luoci66e.cloudfront.net/unsafe/adaptive-full-fit-in/" + p + "/http://" + current_ip_add + "/static/img/store-img/" + a.store.split(".")[0] + "-new.png>";
                    else var q = "<img src=http://d2ifi3luoci66e.cloudfront.net/unsafe/adaptive-full-fit-in/" + p + "/http://" + current_ip_add + "/static/img/store-img/" + a.store.split(".")[0] + ".png>";
                    if (a.delivery && (d = "<li class=delivery-text>Delivery</li><li class=delivery-days>" + a.delivery.slice(0, 50) + " ...</li>"), a.discount ? (c = parseInt(a.discount) + "%<br>off", $(".discount").addClass("discount_box")) : $(".discount").removeClass("discount_box"), a.original_price && (b = "<strike class='original_price_strike'>" + a.original_price + "</strike>"), a.img_urls ? $.each(a.img_urls, function(b) {
                            4 > b && ("amazon" == a.store.split(".")[0] && "no-img-sm._UL1500_.gif" == a.img_urls[b].slice(-22) || "#" == a.img_urls[b] || "" == a.img_urls[b] ? imgurl = "http://" + current_ip_add + "/static/img/img-not-found.png" : imgurl = a.img_urls[b], e += "<li class='sm-lft-img'><div class='sm-imgbx'><center><img src='http://d2ifi3luoci66e.cloudfront.net/unsafe/fit-in/83x83/smart/" + imgurl + "' class='product_img_list img-responsive' data-src='http://d2ifi3luoci66e.cloudfront.net/unsafe/fit-in/317x/smart/" + imgurl + "' onerror='this.src=http://d2ifi3luoci66e.cloudfront.net/unsafe/fit-in/83x83/smart/http://" + current_ip_add + "/static/img/img-not-found.png'></center></div></li>")
                        }) : e = "<li class='sm-lft-img'><div class='sm-imgbx'><center><img src='http://d2ifi3luoci66e.cloudfront.net/unsafe/fit-in/83x83/smart/http://" + current_ip_add + "/static/img/img-not-found.png' class='product_img_list img-responsive' data-src='http://d2ifi3luoci66e.cloudfront.net/unsafe/fit-in/317x/smart/http://" + current_ip_add + "/static/img/img-not-found.png'></center></div></li>", g && $.each(a.kv_pairs, function(b) {
                            f += "<li>" + a.kv_pairs[b] + "</li>"
                        }), f = f, -1 !== o) {
                        var r = n.eq(o);
                        r.removeClass("og-expanded"), preview.$item.addClass("og-expanded"), preview.positionPreview()
                    }
                    o = preview.$item.index();
                    var s = preview.$item.children("div").children(".imgbx_src"),
                        t = {
                            largesrc: s.data("largesrc"),
                            title: s.data("title"),
                            description: f,
                            extra_images: e,
                            price: h,
                            buy_link: m,
                            original_price: b,
                            store: q,
                            delivery: d,
                            discount: c
                        };
                    t.description = t.description.replace(new RegExp("<li>Description :.+?</li>", "gi"), ""), preview.$store.html(t.store), preview.$same_images.html(t.extra_images), preview.$price.html(t.price), preview.$title.html(t.title), preview.$extra_details_ul.html(t.description), preview.$buy_link.attr("href", t.buy_link), preview.$original_price.html(t.original_price), preview.$delivery_ul.html(t.delivery), "" == t.discount ? preview.$discount_ul.html(t.discount) : preview.$discount_ul.html(t.discount), preview.$low_price_text.html("Selling price");
                    $.ajax({
                    url: "/liveupdate/" +encodeURIComponent(a.url),
                    type: "GET",
                    dataType:"json",
                    timeout:8000,
                    success: function(x){ 
                        console.log(x);
                        $('.loading').hide();
                        console.log("New price is => "+x.price);
                        console.log("Original price is => "+x.original_price);
                        console.log("OOS_i is =>", x.oos_i);
                        if (x.oos_i)
                        {
                            $('.buy_link a').css({
                                                    'color':' #000',
                                                    'border': '1px solid #000000',
                                                    'background':'#DDDDDD'
                                                });
                            $('.buy_link a').html("Out of Stock!");
                        }
                        else{                        
                            $('.buy_link a').css({
                                                    'background':' #E67665',
                                                    'color': '#fff',
                                                    'border': '1px solid #E67665'
                                                });                        
                            $('.buy_link a').html("Buy");
                        }
                        //to check if original price has some discount changes
                        var o_price =" ";
                        if (!x.original_price){
                            console.log("under if condition");
                            updated_price = '<i class="fa fa-inr"></i> ' + x.price +" <small class='hidden-xs'><strike>" + o_price + "</strike></small>";
                        }
                        else{
                            updated_price = '<i class="fa fa-inr"></i> ' + x.price+" <small class='hidden-xs'><strike>" + x.original_price + "</strike></small>";
                        }
                        l = x.price, k = document.querySelector(".og-expanded .result-price").textContent.trim(); 
                        console.log("value of l is => "+l);
                        console.log("value of k is => "+k);
                        if(l != k && x.oos_i == false && l != ""){ document.querySelector(".og-expanded .result-price").innerHTML = updated_price;
                        discount = "";
                            if((x.original_price-x.price)>5){
                            $('.discount_box').show();
                            discount = ((x.original_price-x.price)/x.original_price)*100;
                            discount = Math.round( discount );
                            }   
                            else{
                                $('.discount_box').hide();
                            }
                             "" == discount ? preview.$discount_ul.html(discount) : preview.$discount_ul.html(discount+"%<br>off");
                            preview.$original_price.html('<strike>'+x.original_price+'</strike>');
                            preview.$price.html( '<i class="fa fa-inr"></i> ' + x.price);
                            }
                        console.log("updated_price  is "+updated_price);     
                    },
                    error: function(request, status, err){
                        console.log("Error occured!!");
                        if (status == 'timeout') {$('.loading').hide();};
                    }
                    


                });
                    var u = preview;
                    "undefined" != typeof u.$largeImg && u.$largeImg.remove(), u.$fullimage.is(":visible") && (preview.$loading.show(), $("<img/>").load(function() {
                        var a = $(this);
                        a.attr("src") === u.$item.children("div").children(".imgbx_src").data("largesrc") && (u.$loading.hide(), u.$fullimage.find("img").remove(), u.$largeImg = a.fadeIn(350), u.$fullimage.append(u.$largeImg))
                    }).attr("src", t.largesrc)), mixpanel.track_links(".buy_link a", "Buy Product", {})


                }
            })
        },
        open: function() {
            setTimeout($.proxy(function() {
                this.setHeights(), this.positionPreview()
            }, this), 25)
        },
        close: function() {
            var a = this,
                b = function() {
                    w && $(this).off(v), a.$item.removeClass("og-expanded"), a.$previewEl.remove()
                };
            return setTimeout($.proxy(function() {
                "undefined" != typeof this.$largeImg && this.$largeImg.fadeOut("fast"), this.$previewEl.css("height", 0);
                var a = n.eq(this.expandedIdx);
                a.css("height", a.data("height")).on(v, b), w || b.call()
            }, this), 25), !1
        },
        calcHeight: function() {
            var a = k.height - this.$item.data("height") - r,
                b = k.height;
            a < x.minHeight && (a = x.minHeight, b = x.minHeight + this.$item.data("height") + r), this.height = a, this.itemHeight = b, /Android|webOS|iPhone|iPad|iPod|BB|IEMobile|Opera Mini/i.test(navigator.userAgent) && (this.height = 520, this.itemHeight = 780)
        },
        setHeights: function() {
            var a = this,
                b = function() {
                    w && a.$item.off(v), a.$item.addClass("og-expanded")
                };
            this.calcHeight(), this.$previewEl.css("height", this.height), this.$item.css("height", this.itemHeight).on(v, b), w || b.call()
        },
        positionPreview: function() {
            var a = this.$item.data("offsetTop"),
                b = this.$previewEl.offset().top - q,
                c = this.height + this.$item.data("height") + r <= k.height ? a : this.height < k.height ? b - (k.height - this.height) : b;
            t.animate({
                scrollTop: c + 75
            }, x.speed)
        },
        setTransition: function() {
            this.$previewEl.css("transition", "height " + x.speed + "ms " + x.easing), this.$item.css("transition", "height " + x.speed + "ms " + x.easing)
        },
        getEl: function() {
            return this.$previewEl
        }
    }, {
        init: a,
        addItems: b
    }
}();